#!/usr/bin/with-contenv bashio
# ==============================================================================
# Start the example service
# s6-overlay docs: https://github.com/just-containers/s6-overlay
# ==============================================================================

# Add your code here

# Declare variables
DOWNLOAD_SAVE_DIR=/data/download
INSTALL_DIR=/data/bedrock_server
RUN_VERSION=$(bashio::config 'version')

## Print banner
./banner.sh

## EULA check
EULA=$(bashio::config 'eula')
if [[ ${EULA^^} != TRUE ]]; then
  bashio::log.red "EULA must be set to TRUE to indicate agreement with the Minecraft End User License"
  bashio::log.red "See https://minecraft.net/terms"
  bashio::log.red "Current value is '${EULA}'"
  exit 1
fi

if [[ "$RUN_VERSION" = "LATEST" ]]; then
  wget https://mc-bds-helper.vercel.app/api/latest -O /data/latest_version_download_link.txt > /dev/null 2>&1
  if [[ -f "/data/latest_version_download_link.txt" ]]; then
    DOWNLOAD_URL=$(cat /data/latest_version_download_link.txt)
    bashio::log.green "Download URL '${DOWNLOAD_URL}'"
  fi
fi

bashio::log.green "Download Directory ${DOWNLOAD_SAVE_DIR}"

if [[ ! -d  ${DOWNLOAD_SAVE_DIR} ]]; then
  bashio::log "Creating Download Directory"
  mkdir ${DOWNLOAD_SAVE_DIR}
  chmod -R 777 ${DOWNLOAD_SAVE_DIR}
fi

DOWNLOAD_FILE=bedrock-server-1.20.41.02.zip

if [[ ! -f "${DOWNLOAD_SAVE_DIR}/${DOWNLOAD_FILE}" ]]; then
  wget "https://minecraft.azureedge.net/bin-linux/${DOWNLOAD_FILE}" -P ${DOWNLOAD_SAVE_DIR}/
else
  bashio::log.green "${DOWNLOAD_FILE} already downloaded"
fi

if [[ ! -d  ${INSTALL_DIR} ]]; then
  bashio::log "Creating Install Directory"
  mkdir ${INSTALL_DIR}
  chmod -R 777 ${INSTALL_DIR}
fi

SERVER_FILE_NAME=bedrock_server-1.20.41.02

if [[ ! -f "${INSTALL_DIR}/${SERVER_FILE_NAME}" ]]; then
  bashio::log "Installing new version"
  unzip -q -n "${DOWNLOAD_SAVE_DIR}/${DOWNLOAD_FILE}" -d ${INSTALL_DIR}
  mv "${INSTALL_DIR}/bedrock_server" "${INSTALL_DIR}/bedrock_server-1.20.41.02"
else
  bashio::log "Already Installed"
fi

cd "${INSTALL_DIR}" || exit 1

#create server configuration based on ha ui configuration
chmod +x /usr/bin/set_property
/usr/bin/set_property server-name "$(bashio::config 'server_name')" server.properties
/usr/bin/set_property level-name "$(bashio::config 'level_name')" server.properties
/usr/bin/set_property gamemode "$(bashio::config 'level_gamemode')" server.properties
/usr/bin/set_property difficulty "$(bashio::config 'level_difficulty')" server.properties

#prepare and start bedrock server
chmod a+x ./bedrock_server-1.20.41.02
export LD_LIBRARY_PATH=.
./bedrock_server-1.20.41.02



#exec python3 /usr/bin/mc_port_proxy.py
## Run your program
#exec /usr/bin/my_program
